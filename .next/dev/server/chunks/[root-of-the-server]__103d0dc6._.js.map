{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/karim-f/Code/devbridge/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient()\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 89, "column": 0}, "map": {"version":3,"sources":["file:///Users/karim-f/Code/devbridge/src/lib/auth.ts"],"sourcesContent":["import { NextRequest } from 'next/server'\nimport jwt from 'jsonwebtoken'\nimport bcrypt from 'bcryptjs'\nimport { prisma } from './prisma'\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'fallback-secret-change-me'\n\nexport async function hashPassword(password: string): Promise<string> {\n  return bcrypt.hash(password, 12)\n}\n\nexport async function verifyPassword(password: string, hashedPassword: string): Promise<boolean> {\n  return bcrypt.compare(password, hashedPassword)\n}\n\nexport function generateToken(userId: string): string {\n  return jwt.sign({ userId }, JWT_SECRET, { expiresIn: '7d' })\n}\n\nexport function verifyToken(token: string): { userId: string } | null {\n  try {\n    return jwt.verify(token, JWT_SECRET) as { userId: string }\n  } catch {\n    return null\n  }\n}\n\nexport async function validateToken(request: NextRequest): Promise<string | null> {\n  const authHeader = request.headers.get('authorization')\n  if (!authHeader?.startsWith('Bearer ')) {\n    return null\n  }\n\n  const token = authHeader.slice(7)\n  const payload = verifyToken(token)\n  if (!payload) {\n    return null\n  }\n\n  return payload.userId\n}\n\nexport async function getAuthUser(request: NextRequest) {\n  const authHeader = request.headers.get('authorization')\n  if (!authHeader?.startsWith('Bearer ')) {\n    return null\n  }\n\n  const token = authHeader.slice(7)\n  const payload = verifyToken(token)\n  if (!payload) {\n    return null\n  }\n\n  const user = await prisma.user.findUnique({\n    where: { id: payload.userId },\n    select: { id: true, email: true, name: true, isAdmin: true }\n  })\n\n  return user\n}\n\n// Helper function to check if user is admin (for use with already-fetched user)\nexport function isAdminUser(user: { isAdmin?: boolean } | null): boolean {\n  return user?.isAdmin === true\n}\n\nexport async function getProjectByApiKey(apiKey: string) {\n  const project = await prisma.project.findUnique({\n    where: { apiKey }\n  })\n  return project\n}\n\nexport async function validateApiKey(request: NextRequest) {\n  const apiKey = request.headers.get('x-api-key')\n  if (!apiKey) {\n    return null\n  }\n  return getProjectByApiKey(apiKey)\n}\n\nexport async function validateAdmin(request: NextRequest) {\n  const authHeader = request.headers.get('authorization')\n  if (!authHeader?.startsWith('Bearer ')) {\n    return null\n  }\n\n  const token = authHeader.slice(7)\n  const payload = verifyToken(token)\n  if (!payload) {\n    return null\n  }\n\n  const user = await prisma.user.findUnique({\n    where: { id: payload.userId },\n    select: { id: true, email: true, name: true, isAdmin: true }\n  })\n\n  if (!user || !user.isAdmin) {\n    return null\n  }\n\n  return user\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AACA;AACA;AACA;;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAEtC,eAAe,aAAa,QAAgB;IACjD,OAAO,mMAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eAAe,QAAgB,EAAE,cAAsB;IAC3E,OAAO,mMAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAEO,SAAS,cAAc,MAAc;IAC1C,OAAO,2MAAG,CAAC,IAAI,CAAC;QAAE;IAAO,GAAG,YAAY;QAAE,WAAW;IAAK;AAC5D;AAEO,SAAS,YAAY,KAAa;IACvC,IAAI;QACF,OAAO,2MAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,cAAc,OAAoB;IACtD,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,CAAC,YAAY,WAAW,YAAY;QACtC,OAAO;IACT;IAEA,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,MAAM,UAAU,YAAY;IAC5B,IAAI,CAAC,SAAS;QACZ,OAAO;IACT;IAEA,OAAO,QAAQ,MAAM;AACvB;AAEO,eAAe,YAAY,OAAoB;IACpD,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,CAAC,YAAY,WAAW,YAAY;QACtC,OAAO;IACT;IAEA,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,MAAM,UAAU,YAAY;IAC5B,IAAI,CAAC,SAAS;QACZ,OAAO;IACT;IAEA,MAAM,OAAO,MAAM,gIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACxC,OAAO;YAAE,IAAI,QAAQ,MAAM;QAAC;QAC5B,QAAQ;YAAE,IAAI;YAAM,OAAO;YAAM,MAAM;YAAM,SAAS;QAAK;IAC7D;IAEA,OAAO;AACT;AAGO,SAAS,YAAY,IAAkC;IAC5D,OAAO,MAAM,YAAY;AAC3B;AAEO,eAAe,mBAAmB,MAAc;IACrD,MAAM,UAAU,MAAM,gIAAM,CAAC,OAAO,CAAC,UAAU,CAAC;QAC9C,OAAO;YAAE;QAAO;IAClB;IACA,OAAO;AACT;AAEO,eAAe,eAAe,OAAoB;IACvD,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;IACnC,IAAI,CAAC,QAAQ;QACX,OAAO;IACT;IACA,OAAO,mBAAmB;AAC5B;AAEO,eAAe,cAAc,OAAoB;IACtD,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,CAAC,YAAY,WAAW,YAAY;QACtC,OAAO;IACT;IAEA,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,MAAM,UAAU,YAAY;IAC5B,IAAI,CAAC,SAAS;QACZ,OAAO;IACT;IAEA,MAAM,OAAO,MAAM,gIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACxC,OAAO;YAAE,IAAI,QAAQ,MAAM;QAAC;QAC5B,QAAQ;YAAE,IAAI;YAAM,OAAO;YAAM,MAAM;YAAM,SAAS;QAAK;IAC7D;IAEA,IAAI,CAAC,QAAQ,CAAC,KAAK,OAAO,EAAE;QAC1B,OAAO;IACT;IAEA,OAAO;AACT"}},
    {"offset": {"line": 221, "column": 0}, "map": {"version":3,"sources":["file:///Users/karim-f/Code/devbridge/src/app/api/business-config/analytics/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { getAuthUser } from '@/lib/auth'\n\n/**\n * GET /api/business-config/analytics\n * Get analytics for business config usage\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const user = await getAuthUser(request)\n    if (!user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const projectId = searchParams.get('projectId')\n    const configKey = searchParams.get('configKey')\n    const startDate = searchParams.get('startDate')\n    const endDate = searchParams.get('endDate')\n\n    if (!projectId) {\n      return NextResponse.json(\n        { error: 'projectId is required' },\n        { status: 400 }\n      )\n    }\n\n    // Verify project ownership\n    const project = await prisma.project.findFirst({\n      where: { id: projectId, userId: user.id }\n    })\n\n    if (!project) {\n      return NextResponse.json({ error: 'Project not found' }, { status: 404 })\n    }\n\n    // Build where clause\n    let where: any = { projectId }\n    if (configKey) {\n      where.configKey = configKey\n    }\n    if (startDate || endDate) {\n      where.lastFetchedAt = {}\n      if (startDate) {\n        where.lastFetchedAt.gte = new Date(startDate)\n      }\n      if (endDate) {\n        where.lastFetchedAt.lte = new Date(endDate)\n      }\n    }\n\n    // Get usage metrics\n    const metrics = await prisma.configUsageMetric.findMany({\n      where,\n      orderBy: {\n        lastFetchedAt: 'desc'\n      }\n    })\n\n    // Aggregate statistics\n    const stats = {\n      totalFetches: metrics.reduce((sum, m) => sum + m.fetchCount, 0),\n      uniqueDevices: new Set(metrics.filter(m => m.deviceId).map(m => m.deviceId)).size,\n      uniqueUsers: new Set(metrics.filter(m => m.userId).map(m => m.userId)).size,\n      cacheHitRate: metrics.length > 0\n        ? metrics.filter(m => m.cacheHit).length / metrics.length\n        : 0,\n      targetingMatchRate: metrics.length > 0\n        ? metrics.filter(m => m.targetingMatched).length / metrics.length\n        : 0,\n      rolloutReceiveRate: metrics.length > 0\n        ? metrics.filter(m => m.rolloutReceived).length / metrics.length\n        : 0\n    }\n\n    // Group by config key\n    const byConfigKey = metrics.reduce((acc, m) => {\n      if (!acc[m.configKey]) {\n        acc[m.configKey] = {\n          configKey: m.configKey,\n          totalFetches: 0,\n          uniqueDevices: new Set<string>(),\n          uniqueUsers: new Set<string>(),\n          cacheHits: 0,\n          targetingMatches: 0,\n          rolloutReceives: 0\n        }\n      }\n      acc[m.configKey].totalFetches += m.fetchCount\n      if (m.deviceId) acc[m.configKey].uniqueDevices.add(m.deviceId)\n      if (m.userId) acc[m.configKey].uniqueUsers.add(m.userId)\n      if (m.cacheHit) acc[m.configKey].cacheHits++\n      if (m.targetingMatched) acc[m.configKey].targetingMatches++\n      if (m.rolloutReceived) acc[m.configKey].rolloutReceives++\n      return acc\n    }, {} as Record<string, any>)\n\n    // Convert sets to counts\n    Object.keys(byConfigKey).forEach(key => {\n      byConfigKey[key].uniqueDevices = byConfigKey[key].uniqueDevices.size\n      byConfigKey[key].uniqueUsers = byConfigKey[key].uniqueUsers.size\n    })\n\n    return NextResponse.json({\n      stats,\n      byConfigKey: Object.values(byConfigKey),\n      metrics: metrics.slice(0, 100) // Limit to recent 100\n    })\n  } catch (error) {\n    console.error('Get config analytics error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}