{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/karim-f/Code/devbridge/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient()\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 89, "column": 0}, "map": {"version":3,"sources":["file:///Users/karim-f/Code/devbridge/src/lib/auth.ts"],"sourcesContent":["import { NextRequest } from 'next/server'\nimport jwt from 'jsonwebtoken'\nimport bcrypt from 'bcryptjs'\nimport { prisma } from './prisma'\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'fallback-secret-change-me'\n\nexport async function hashPassword(password: string): Promise<string> {\n  return bcrypt.hash(password, 12)\n}\n\nexport async function verifyPassword(password: string, hashedPassword: string): Promise<boolean> {\n  return bcrypt.compare(password, hashedPassword)\n}\n\nexport function generateToken(userId: string): string {\n  return jwt.sign({ userId }, JWT_SECRET, { expiresIn: '7d' })\n}\n\nexport function verifyToken(token: string): { userId: string } | null {\n  try {\n    return jwt.verify(token, JWT_SECRET) as { userId: string }\n  } catch {\n    return null\n  }\n}\n\nexport async function validateToken(request: NextRequest): Promise<string | null> {\n  const authHeader = request.headers.get('authorization')\n  if (!authHeader?.startsWith('Bearer ')) {\n    return null\n  }\n\n  const token = authHeader.slice(7)\n  const payload = verifyToken(token)\n  if (!payload) {\n    return null\n  }\n\n  return payload.userId\n}\n\nexport async function getAuthUser(request: NextRequest) {\n  const authHeader = request.headers.get('authorization')\n  if (!authHeader?.startsWith('Bearer ')) {\n    return null\n  }\n\n  const token = authHeader.slice(7)\n  const payload = verifyToken(token)\n  if (!payload) {\n    return null\n  }\n\n  const user = await prisma.user.findUnique({\n    where: { id: payload.userId },\n    select: { id: true, email: true, name: true, isAdmin: true }\n  })\n\n  return user\n}\n\n// Helper function to check if user is admin (for use with already-fetched user)\nexport function isAdminUser(user: { isAdmin?: boolean } | null): boolean {\n  return user?.isAdmin === true\n}\n\nexport async function getProjectByApiKey(apiKey: string) {\n  const project = await prisma.project.findUnique({\n    where: { apiKey }\n  })\n  return project\n}\n\nexport async function validateApiKey(request: NextRequest) {\n  const apiKey = request.headers.get('x-api-key')\n  if (!apiKey) {\n    return null\n  }\n  return getProjectByApiKey(apiKey)\n}\n\nexport async function validateAdmin(request: NextRequest) {\n  const authHeader = request.headers.get('authorization')\n  if (!authHeader?.startsWith('Bearer ')) {\n    return null\n  }\n\n  const token = authHeader.slice(7)\n  const payload = verifyToken(token)\n  if (!payload) {\n    return null\n  }\n\n  const user = await prisma.user.findUnique({\n    where: { id: payload.userId },\n    select: { id: true, email: true, name: true, isAdmin: true }\n  })\n\n  if (!user || !user.isAdmin) {\n    return null\n  }\n\n  return user\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AACA;AACA;AACA;;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAEtC,eAAe,aAAa,QAAgB;IACjD,OAAO,mMAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eAAe,QAAgB,EAAE,cAAsB;IAC3E,OAAO,mMAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAEO,SAAS,cAAc,MAAc;IAC1C,OAAO,2MAAG,CAAC,IAAI,CAAC;QAAE;IAAO,GAAG,YAAY;QAAE,WAAW;IAAK;AAC5D;AAEO,SAAS,YAAY,KAAa;IACvC,IAAI;QACF,OAAO,2MAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,cAAc,OAAoB;IACtD,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,CAAC,YAAY,WAAW,YAAY;QACtC,OAAO;IACT;IAEA,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,MAAM,UAAU,YAAY;IAC5B,IAAI,CAAC,SAAS;QACZ,OAAO;IACT;IAEA,OAAO,QAAQ,MAAM;AACvB;AAEO,eAAe,YAAY,OAAoB;IACpD,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,CAAC,YAAY,WAAW,YAAY;QACtC,OAAO;IACT;IAEA,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,MAAM,UAAU,YAAY;IAC5B,IAAI,CAAC,SAAS;QACZ,OAAO;IACT;IAEA,MAAM,OAAO,MAAM,gIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACxC,OAAO;YAAE,IAAI,QAAQ,MAAM;QAAC;QAC5B,QAAQ;YAAE,IAAI;YAAM,OAAO;YAAM,MAAM;YAAM,SAAS;QAAK;IAC7D;IAEA,OAAO;AACT;AAGO,SAAS,YAAY,IAAkC;IAC5D,OAAO,MAAM,YAAY;AAC3B;AAEO,eAAe,mBAAmB,MAAc;IACrD,MAAM,UAAU,MAAM,gIAAM,CAAC,OAAO,CAAC,UAAU,CAAC;QAC9C,OAAO;YAAE;QAAO;IAClB;IACA,OAAO;AACT;AAEO,eAAe,eAAe,OAAoB;IACvD,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;IACnC,IAAI,CAAC,QAAQ;QACX,OAAO;IACT;IACA,OAAO,mBAAmB;AAC5B;AAEO,eAAe,cAAc,OAAoB;IACtD,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,CAAC,YAAY,WAAW,YAAY;QACtC,OAAO;IACT;IAEA,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,MAAM,UAAU,YAAY;IAC5B,IAAI,CAAC,SAAS;QACZ,OAAO;IACT;IAEA,MAAM,OAAO,MAAM,gIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACxC,OAAO;YAAE,IAAI,QAAQ,MAAM;QAAC;QAC5B,QAAQ;YAAE,IAAI;YAAM,OAAO;YAAM,MAAM;YAAM,SAAS;QAAK;IAC7D;IAEA,IAAI,CAAC,QAAQ,CAAC,KAAK,OAAO,EAAE;QAC1B,OAAO;IACT;IAEA,OAAO;AACT"}},
    {"offset": {"line": 221, "column": 0}, "map": {"version":3,"sources":["file:///Users/karim-f/Code/devbridge/src/app/api/analytics/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { verifyToken } from '@/lib/auth'\n\n// GET - Get cost analytics for a project\nexport async function GET(request: NextRequest) {\n  try {\n    const authHeader = request.headers.get('authorization')\n    const projectId = request.nextUrl.searchParams.get('projectId')\n    const deviceId = request.nextUrl.searchParams.get('deviceId')\n\n    if (!authHeader || !projectId) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const token = authHeader.replace('Bearer ', '')\n    const payload = verifyToken(token)\n\n    if (!payload) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    // Verify project ownership\n    const project = await prisma.project.findFirst({\n      where: {\n        id: projectId,\n        userId: payload.userId\n      }\n    })\n\n    if (!project) {\n      return NextResponse.json({ error: 'Project not found' }, { status: 404 })\n    }\n\n    const whereClause: Record<string, unknown> = { projectId }\n    if (deviceId) {\n      whereClause.deviceId = deviceId\n    }\n\n    // Total cost of all requests\n    const totalCostResult = await prisma.apiTrace.aggregate({\n      where: whereClause,\n      _sum: { cost: true },\n      _count: true\n    })\n\n    // Cost by endpoint\n    const tracesByEndpoint = await prisma.apiTrace.groupBy({\n      by: ['url', 'method'],\n      where: whereClause,\n      _sum: { cost: true },\n      _count: true,\n      orderBy: { _sum: { cost: 'desc' } },\n      take: 20\n    })\n\n    // Cost by device\n    const deviceCosts = await prisma.apiTrace.groupBy({\n      by: ['deviceId'],\n      where: { ...whereClause, deviceId: { not: null } },\n      _sum: { cost: true },\n      _count: true,\n      orderBy: { _sum: { cost: 'desc' } }\n    })\n\n    // Get device details for the cost breakdown\n    const deviceIds = deviceCosts.map(d => d.deviceId).filter(Boolean) as string[]\n    const devices = await prisma.device.findMany({\n      where: { id: { in: deviceIds } },\n      select: {\n        id: true,\n        deviceId: true,\n        platform: true,\n        model: true\n      }\n    })\n\n    const deviceCostsWithDetails = deviceCosts.map(dc => {\n      const device = devices.find(d => d.id === dc.deviceId)\n      return {\n        deviceId: dc.deviceId,\n        device: device || null,\n        totalCost: dc._sum.cost || 0,\n        requestCount: dc._count\n      }\n    })\n\n    // Cost by session (recent sessions)\n    const sessionCosts = await prisma.session.findMany({\n      where: { projectId, ...(deviceId ? { deviceId } : {}) },\n      include: {\n        device: {\n          select: {\n            deviceId: true,\n            platform: true,\n            model: true\n          }\n        },\n        _count: {\n          select: { apiTraces: true }\n        }\n      },\n      orderBy: { startedAt: 'desc' },\n      take: 50\n    })\n\n    const sessionsWithCost = await Promise.all(\n      sessionCosts.map(async (session) => {\n        const costResult = await prisma.apiTrace.aggregate({\n          where: { sessionId: session.id },\n          _sum: { cost: true }\n        })\n\n        return {\n          id: session.id,\n          sessionToken: session.sessionToken.slice(0, 8) + '...',\n          startedAt: session.startedAt,\n          endedAt: session.endedAt,\n          isActive: session.isActive,\n          device: session.device,\n          requestCount: session._count.apiTraces,\n          totalCost: costResult._sum.cost || 0\n        }\n      })\n    )\n\n    // Unique endpoints cost (cost of distinct API calls)\n    const uniqueEndpointsCost = tracesByEndpoint.reduce((sum, e) => {\n      // Get the cost per request config for this endpoint\n      const costPerRequest = e._sum.cost ? e._sum.cost / e._count : 0\n      return sum + costPerRequest\n    }, 0)\n\n    // Format endpoint costs\n    const endpointCosts = tracesByEndpoint.map(e => {\n      let endpointPath: string\n      try {\n        const url = new URL(e.url)\n        endpointPath = url.pathname\n      } catch {\n        endpointPath = e.url\n      }\n\n      return {\n        endpoint: endpointPath,\n        method: e.method,\n        fullUrl: e.url,\n        totalCost: e._sum.cost || 0,\n        requestCount: e._count,\n        avgCostPerRequest: e._count > 0 ? (e._sum.cost || 0) / e._count : 0\n      }\n    })\n\n    return NextResponse.json({\n      summary: {\n        totalCost: totalCostResult._sum.cost || 0,\n        totalRequests: totalCostResult._count,\n        uniqueEndpointsCost,\n        avgCostPerRequest: totalCostResult._count > 0\n          ? (totalCostResult._sum.cost || 0) / totalCostResult._count\n          : 0\n      },\n      endpointCosts,\n      deviceCosts: deviceCostsWithDetails,\n      sessionCosts: sessionsWithCost\n    })\n  } catch (error) {\n    console.error('Analytics GET error:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}