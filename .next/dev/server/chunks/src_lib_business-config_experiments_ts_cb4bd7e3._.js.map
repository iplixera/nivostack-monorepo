{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/karim-f/Code/devbridge/src/lib/business-config/experiments.ts"],"sourcesContent":["/**\n * Experiment Assignment Engine\n * Handles consistent assignment of users/devices to experiment variants\n */\n\nexport interface ExperimentVariant {\n  value: any\n  weight: number // Percentage (0-100)\n  name: string\n}\n\nexport interface Experiment {\n  id: string\n  variants: ExperimentVariant[]\n  assignmentType: 'random' | 'consistent' | 'targeting'\n  targetingRules?: any\n}\n\nexport interface AssignmentContext {\n  deviceId?: string\n  userId?: string\n  [key: string]: any\n}\n\n/**\n * Assign user/device to a variant consistently\n * Uses hash-based assignment for consistent results\n */\nexport function assignToVariant(\n  experiment: Experiment,\n  context: AssignmentContext\n): { variantIndex: number; variant: ExperimentVariant } | null {\n  if (!experiment.variants || experiment.variants.length === 0) {\n    return null\n  }\n\n  // Normalize weights (ensure they sum to 100)\n  const totalWeight = experiment.variants.reduce((sum, v) => sum + v.weight, 0)\n  const normalizedVariants = experiment.variants.map(v => ({\n    ...v,\n    weight: (v.weight / totalWeight) * 100\n  }))\n\n  // Get identifier for consistent assignment\n  const identifier = context.userId || context.deviceId || 'default'\n  \n  // Generate hash\n  const hash = simpleHash(`${experiment.id}:${identifier}`)\n  const percentage = (hash % 10000) / 100 // 0-99.99\n\n  // Assign based on cumulative weights\n  let cumulative = 0\n  for (let i = 0; i < normalizedVariants.length; i++) {\n    cumulative += normalizedVariants[i].weight\n    if (percentage < cumulative) {\n      return {\n        variantIndex: i,\n        variant: normalizedVariants[i]\n      }\n    }\n  }\n\n  // Fallback to last variant\n  return {\n    variantIndex: normalizedVariants.length - 1,\n    variant: normalizedVariants[normalizedVariants.length - 1]\n  }\n}\n\n/**\n * Simple hash function for consistent assignment\n */\nfunction simpleHash(str: string): number {\n  let hash = 0\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i)\n    hash = ((hash << 5) - hash) + char\n    hash = hash & hash // Convert to 32-bit integer\n  }\n  return Math.abs(hash)\n}\n\n/**\n * Calculate experiment statistics\n */\nexport function calculateExperimentStats(\n  assignments: Array<{ variantIndex: number; createdAt: Date }>,\n  events: Array<{ variantIndex: number; eventType: string; eventValue?: number }>\n): {\n  variants: Array<{\n    variantIndex: number\n    assignments: number\n    conversions: number\n    conversionRate: number\n    totalValue: number\n    avgValue: number\n  }>\n  totalAssignments: number\n  totalConversions: number\n  overallConversionRate: number\n} {\n  const variantStats: Record<number, {\n    assignments: number\n    conversions: number\n    totalValue: number\n  }> = {}\n\n  // Count assignments per variant\n  assignments.forEach(a => {\n    if (!variantStats[a.variantIndex]) {\n      variantStats[a.variantIndex] = {\n        assignments: 0,\n        conversions: 0,\n        totalValue: 0\n      }\n    }\n    variantStats[a.variantIndex].assignments++\n  })\n\n  // Count conversions per variant\n  events.forEach(e => {\n    if (e.eventType === 'conversion' && variantStats[e.variantIndex]) {\n      variantStats[e.variantIndex].conversions++\n      if (e.eventValue) {\n        variantStats[e.variantIndex].totalValue += e.eventValue\n      }\n    }\n  })\n\n  // Calculate rates\n  const variantResults = Object.entries(variantStats).map(([index, stats]) => ({\n    variantIndex: parseInt(index),\n    assignments: stats.assignments,\n    conversions: stats.conversions,\n    conversionRate: stats.assignments > 0 ? stats.conversions / stats.assignments : 0,\n    totalValue: stats.totalValue,\n    avgValue: stats.conversions > 0 ? stats.totalValue / stats.conversions : 0\n  }))\n\n  const totalAssignments = assignments.length\n  const totalConversions = events.filter(e => e.eventType === 'conversion').length\n  const overallConversionRate = totalAssignments > 0 ? totalConversions / totalAssignments : 0\n\n  return {\n    variants: variantResults,\n    totalAssignments,\n    totalConversions,\n    overallConversionRate\n  }\n}\n\n/**\n * Calculate statistical significance using chi-square test\n */\nexport function calculateStatisticalSignificance(\n  variantA: { assignments: number; conversions: number },\n  variantB: { assignments: number; conversions: number }\n): {\n  significant: boolean\n  pValue: number\n  confidence: number\n} {\n  // Simplified chi-square test\n  const totalAssignments = variantA.assignments + variantB.assignments\n  const totalConversions = variantA.conversions + variantB.conversions\n  const totalNonConversions = totalAssignments - totalConversions\n\n  if (totalAssignments === 0) {\n    return { significant: false, pValue: 1, confidence: 0 }\n  }\n\n  const expectedRate = totalConversions / totalAssignments\n  const expectedA = variantA.assignments * expectedRate\n  const expectedB = variantB.assignments * expectedRate\n  const expectedANon = variantA.assignments * (1 - expectedRate)\n  const expectedBNon = variantB.assignments * (1 - expectedRate)\n\n  // Chi-square statistic\n  const chiSquare = \n    Math.pow(variantA.conversions - expectedA, 2) / expectedA +\n    Math.pow(variantB.conversions - expectedB, 2) / expectedB +\n    Math.pow((variantA.assignments - variantA.conversions) - expectedANon, 2) / expectedANon +\n    Math.pow((variantB.assignments - variantB.conversions) - expectedBNon, 2) / expectedBNon\n\n  // Degrees of freedom = 1 (2 variants - 1)\n  // Critical value for 95% confidence = 3.84\n  const criticalValue = 3.84\n  const significant = chiSquare > criticalValue\n  \n  // Approximate p-value (simplified)\n  const pValue = significant ? 0.05 : 0.5\n  const confidence = significant ? 95 : 50\n\n  return { significant, pValue, confidence }\n}\n\n"],"names":[],"mappings":"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"}}]
}