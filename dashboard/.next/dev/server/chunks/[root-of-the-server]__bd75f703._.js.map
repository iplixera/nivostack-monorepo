{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/karim-f/Code/nivostack-monorepo-checkout/dashboard/src/app/api/health/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { exec } from 'child_process'\nimport { promisify } from 'util'\nimport path from 'path'\n\nconst execAsync = promisify(exec)\n\n// Track migration status per instance\nlet migrationChecked = false\nlet migrationRunning = false\n\n/**\n * GET /api/health\n * Health check endpoint that also runs migrations on first call after deployment\n * This ensures migrations run automatically when the app starts\n */\nexport async function GET(request: NextRequest) {\n    try {\n        const dbUrl = process.env.POSTGRES_URL_NON_POOLING\n\n        // Run migration on first health check (after deployment)\n        if (!migrationChecked && !migrationRunning && dbUrl) {\n            migrationRunning = true\n\n            try {\n        // Get the correct path to prisma schema\n        // In Vercel, we need to resolve from the dashboard directory\n        const cwd = typeof process.cwd === 'function' ? process.cwd() : '/vercel/path0/dashboard'\n        const schemaPath = path.join(cwd, '..', 'prisma', 'schema.prisma')\n        \n        console.log('üîÑ Running database migration...')\n        console.log('Schema path:', schemaPath)\n        console.log('Working directory:', cwd)\n        \n        // Use npx instead of pnpm dlx (pnpm not available in Vercel runtime)\n        // npx is available and will use the locally installed prisma\n        const { stdout, stderr } = await execAsync(\n          `npx --yes prisma@5.22.0 db push --schema=\"${schemaPath}\" --accept-data-loss --skip-generate`,\n          {\n            cwd: cwd,\n            timeout: 60000, // 60 seconds\n            maxBuffer: 10 * 1024 * 1024, // 10MB\n            env: {\n              ...process.env,\n              POSTGRES_PRISMA_URL: dbUrl,\n              POSTGRES_URL_NON_POOLING: dbUrl,\n            },\n          }\n        )\n\n                migrationChecked = true\n                migrationRunning = false\n\n                console.log('‚úÖ Migration completed:', stdout)\n                if (stderr) {\n                    console.warn('Migration warnings:', stderr)\n                }\n\n                return NextResponse.json({\n                    status: 'ok',\n                    timestamp: new Date().toISOString(),\n                    migration: 'completed',\n                    output: stdout.substring(0, 500), // First 500 chars\n                })\n            } catch (error: any) {\n                migrationRunning = false\n                console.error('‚ùå Migration error:', error.message)\n\n                return NextResponse.json(\n                    {\n                        status: 'error',\n                        timestamp: new Date().toISOString(),\n                        migration: 'failed',\n                        error: error.message,\n                        output: error.stdout?.substring(0, 500) || null,\n                        errors: error.stderr?.substring(0, 500) || null,\n                    },\n                    { status: 500 }\n                )\n            }\n        }\n\n        return NextResponse.json({\n            status: 'ok',\n            timestamp: new Date().toISOString(),\n            migration: migrationChecked ? 'already_completed' : 'not_configured',\n            database: dbUrl ? 'configured' : 'not_configured',\n        })\n    } catch (error: any) {\n        return NextResponse.json(\n            {\n                status: 'error',\n                error: error.message,\n            },\n            { status: 500 }\n        )\n    }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,YAAY,IAAA,8GAAS,EAAC,2HAAI;AAEhC,sCAAsC;AACtC,IAAI,mBAAmB;AACvB,IAAI,mBAAmB;AAOhB,eAAe,IAAI,OAAoB;IAC1C,IAAI;QACA,MAAM,QAAQ,QAAQ,GAAG,CAAC,wBAAwB;QAElD,yDAAyD;QACzD,IAAI,CAAC,oBAAoB,CAAC,oBAAoB,OAAO;YACjD,mBAAmB;YAEnB,IAAI;gBACR,wCAAwC;gBACxC,6DAA6D;gBAC7D,MAAM,MAAM,OAAO,QAAQ,GAAG,KAAK,aAAa,QAAQ,GAAG,KAAK;gBAChE,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,KAAK,MAAM,UAAU;gBAElD,QAAQ,GAAG,CAAC;gBACZ,QAAQ,GAAG,CAAC,gBAAgB;gBAC5B,QAAQ,GAAG,CAAC,sBAAsB;gBAElC,qEAAqE;gBACrE,6DAA6D;gBAC7D,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,UAC/B,CAAC,0CAA0C,EAAE,WAAW,oCAAoC,CAAC,EAC7F;oBACE,KAAK;oBACL,SAAS;oBACT,WAAW,KAAK,OAAO;oBACvB,KAAK;wBACH,GAAG,QAAQ,GAAG;wBACd,qBAAqB;wBACrB,0BAA0B;oBAC5B;gBACF;gBAGM,mBAAmB;gBACnB,mBAAmB;gBAEnB,QAAQ,GAAG,CAAC,0BAA0B;gBACtC,IAAI,QAAQ;oBACR,QAAQ,IAAI,CAAC,uBAAuB;gBACxC;gBAEA,OAAO,iTAAY,CAAC,IAAI,CAAC;oBACrB,QAAQ;oBACR,WAAW,IAAI,OAAO,WAAW;oBACjC,WAAW;oBACX,QAAQ,OAAO,SAAS,CAAC,GAAG;gBAChC;YACJ,EAAE,OAAO,OAAY;gBACjB,mBAAmB;gBACnB,QAAQ,KAAK,CAAC,sBAAsB,MAAM,OAAO;gBAEjD,OAAO,iTAAY,CAAC,IAAI,CACpB;oBACI,QAAQ;oBACR,WAAW,IAAI,OAAO,WAAW;oBACjC,WAAW;oBACX,OAAO,MAAM,OAAO;oBACpB,QAAQ,MAAM,MAAM,EAAE,UAAU,GAAG,QAAQ;oBAC3C,QAAQ,MAAM,MAAM,EAAE,UAAU,GAAG,QAAQ;gBAC/C,GACA;oBAAE,QAAQ;gBAAI;YAEtB;QACJ;QAEA,OAAO,iTAAY,CAAC,IAAI,CAAC;YACrB,QAAQ;YACR,WAAW,IAAI,OAAO,WAAW;YACjC,WAAW,mBAAmB,sBAAsB;YACpD,UAAU,QAAQ,eAAe;QACrC;IACJ,EAAE,OAAO,OAAY;QACjB,OAAO,iTAAY,CAAC,IAAI,CACpB;YACI,QAAQ;YACR,OAAO,MAAM,OAAO;QACxB,GACA;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}